<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime In-Day Comparison Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    body {
      font-family: 'Be Vietnam Pro', sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #chart {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>

<body>

<div id="chart"></div>

<script>
  const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);

  const today = new Date();
  today.setDate(today.getDate() - 2);

  const compareDay = new Date(today);
  compareDay.setDate(today.getDate() - 1);

  const todayStr = today.toISOString().slice(0, 10);
  const compareStr = compareDay.toISOString().slice(0, 10);

  const todayData = [
    1000, 1800, 2501, 3100, 4000,
    5300, 6200, 7000, 8050, 9230, 10120
  ];

  const growthRates = todayData.slice(1).map((v, i) => v / todayData[i]);
  const avgGrowth = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;

  const compareData = [];
  for (let i = 0; i < 24; i++) {
    if (i < todayData.length) {
      compareData[i] = Math.round(todayData[i] * (1.1 + Math.random() * 0.02));
    } else {
      const prev = compareData[i - 1];
      const next = Math.round(prev * (1 + (avgGrowth - 1) * (0.25 + Math.random() * 0.022)));
      compareData[i] = Math.max(next, prev + 100);
    }
  }

  const source = hours.map((h, i) => ({
    Hour: h,
    Today: i < todayData.length ? todayData[i] : null,
    Compare: compareData[i]
  }));

  const lastIdx = todayData.length - 1;
  const lastPoint = [hours[lastIdx], todayData[lastIdx]];

  const option = {
    color: ['#145dfc', '#03c950'],

    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'line' },
      backgroundColor: 'rgba(255,255,255,0.95)',
      textStyle: { fontFamily: 'Be Vietnam Pro', color: '#000' },

      formatter: params => {
        let html = `<div style="font-family:'Be Vietnam Pro',sans-serif;">`;
        html += `<strong>${params[0].axisValue}</strong><br/>`;

        const idx = params[0].dataIndex;
        let todayVal = null;
        let compareVal = null;

        params.forEach(p => {
            if (p.seriesIndex < 2) { 
                const val = p.value[1] != null ? p.value[1].toLocaleString() : '–';
                
                // ĐÃ SỬA: Buộc màu xanh lá cho Compare Date (seriesIndex 1) trong Tooltip
                const markerColor = p.seriesIndex === 1 ? '#03c950' : p.color; 
                const markerHtml = `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${markerColor};"></span>`;

                html += `${markerHtml} ${p.seriesName}: ${val}<br/>`;

                if (p.seriesIndex === 0) todayVal = p.value[1];
                if (p.seriesIndex === 1) compareVal = p.value[1];
            }
        });

        // === Logic tăng giảm % ===
        if (todayVal != null && compareVal != null) {
          const diff = todayVal - compareVal;
          const diffPercent = (diff / compareVal) * 100;

          const sign = diffPercent >= 0 ? "▲" : "▼";
          const color = diffPercent >= 0 ? "#03c950" : "#EA3323";

          html += `<span style="color:${color};">${sign}${Math.abs(diffPercent).toFixed(1)}%</span> vs Same Time Compare Date`;
        }

        html += `</div>`;
        return html;
      }
    },

    legend: {
      bottom: 0,
      left: 'center',
      icon: 'circle',
      textStyle: { fontFamily: 'Be Vietnam Pro' },
      data: [
        { name: `Today ${todayStr}` },
        { 
          name: `Compare Date ${compareStr}`,
          itemStyle: { color: '#03c950' } 
        }
      ]
    },

    grid: {
      top: 40,
      left: 50,
      right: 30,
      bottom: 60
    },

    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: hours,
      axisLabel: { fontFamily: 'Be Vietnam Pro' }
    },

    yAxis: {
      type: 'value',
      axisLabel: {
        fontFamily: 'Be Vietnam Pro',
        formatter: v => v.toLocaleString()
      },
      splitLine: { lineStyle: { type: 'dashed' } }
    },

    series: [
      {
        name: `Today ${todayStr}`,
        type: 'line',
        smooth: false,
        symbolSize: 6,
        data: source.map(d => [d.Hour, d.Today]),
        lineStyle: { width: 3, color: '#145dfc' },
        itemStyle: { color: '#145dfc' },
        label: {
          show: true,
          position: 'top',
          formatter: p =>
            p.dataIndex === todayData.length - 1
              ? p.value[1].toLocaleString()
              : ''
        }
      },
      {
        name: `Compare Date ${compareStr}`,
        type: 'line',
        smooth: false,
        symbol: 'none',
        lineStyle: { width: 2, color: '#03c950', type: 'dashed' },
        data: source.map(d => [d.Hour, d.Compare])
      },
      // Effect Scatter
      {
        type: 'effectScatter',
        coordinateSystem: 'cartesian2d',
        data: [lastPoint],
        symbolSize: 12,
        rippleEffect: { brushType: 'stroke', scale: 4, period: 3 },
        itemStyle: { color: '#145dfc', shadowBlur: 20, shadowColor: '#145dfc' },
        tooltip: { show: false },
        zlevel: 1
      }
    ]
  };

  const chartDom = document.getElementById('chart');
  const myChart = echarts.init(chartDom);
  myChart.setOption(option);

  window.addEventListener('resize', () => myChart.resize());
</script>

</body>
</html>