<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Metrics Table with Toggles and Sorting</title>
<style>
  body {
    font-family: 'Be Vietnam Pro', sans-serif;
    padding: 20px;
    background: #fff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px 15px;
    text-align: left;
    vertical-align: middle;
  }
  th {
    background-color: #f5f5f5;
    font-weight: 600;
  }
  /* Style for clickable headers */
  th:not(:first-child) {
    cursor: pointer;
  }
  tr:nth-child(even){background-color: #fafafa;}
  .positive { color: #03c950; font-weight: 600; }
  .negative { color: #ed5a27; font-weight: 600; }
  .toggles {
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div class="toggles">
  <label><input type="checkbox" id="showPercent" checked> Show % of Total</label>
  &nbsp;&nbsp;
  <label><input type="checkbox" id="showDoD"> Show DoD</label>
</div>

<table>
  <thead>
    <tr>
      <th>Top Product</th>
      <th>Gross Booking</th>
      <th>Success Trans</th>
      <th>PU</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<script>
const data = [
  { dimension: 'package.ws1.royal.web', gross: 120000, prevGross: 100000, success: 110, prevSuccess: 95, pu: 90, prevPU: 85 },
  { dimension: 'package.ws2.silver.web', gross: 90000, prevGross: 95000, success: 85, prevSuccess: 90, pu: 80, prevPU: 85 },
  { dimension: 'package.ws3.gold.web', gross: 150000, prevGross: 130000, success: 140, prevSuccess: 120, pu: 130, prevPU: 110 },
  { dimension: 'package.ws4.platinum.web', gross: 70000, prevGross: 70000, success: 65, prevSuccess: 65, pu: 60, prevPU: 60 },
  { dimension: 'package.ws5.basic.web', gross: 50000, prevGross: 45000, success: 45, prevSuccess: 42, pu: 40, prevPU: 38 },
  { dimension: 'package.ws6.standard.web', gross: 60000, prevGross: 55000, success: 55, prevSuccess: 50, pu: 50, prevPU: 48 },
  { dimension: 'package.ws7.premium.web', gross: 80000, prevGross: 75000, success: 75, prevSuccess: 70, pu: 70, prevPU: 65 }
];

const tbody = document.getElementById('table-body');
const showPercent = document.getElementById('showPercent');
const showDoD = document.getElementById('showDoD');
const headers = document.querySelectorAll('th:not(:first-child)'); 

// THAY ĐỔI: Thiết lập trạng thái mặc định: sort theo 'gross' giảm dần ('desc')
let sortState = {
    column: 'gross',
    direction: 'asc' 
};

// --- Sorting Logic ---
function sortData(column) {
    // Determine new direction
    let direction = 'asc';
    if (sortState.column === column) {
        // Toggle direction if clicking the same column
        direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    }
    
    // Perform the sort
    data.sort((a, b) => {
        const valA = a[column];
        const valB = b[column];

        if (direction === 'asc') {
            return valA - valB;
        } else {
            return valB - valA;
        }
    });

    // Update sort state
    sortState.column = column;
    sortState.direction = direction;
    
    // Re-render
    renderTable();
    updateHeaderIcons();
}

function updateHeaderIcons() {
    // Clear all existing icons
    headers.forEach(header => {
        // Remove existing triangles (▲ \u25B2 or ▼ \u25BC) from the inner text
        header.innerHTML = header.innerText.replace(/ \u25B2| \u25BC/g, ''); 
    });

    if (sortState.column) {
        // Find the currently sorted header and add the icon
        const sortedHeader = Array.from(headers).find(h => {
            const headerText = h.innerText.toLowerCase().replace(/ /g, ''); 
            // Map header text to the data key
            if (headerText.includes('grossbooking') && sortState.column === 'gross') return true;
            if (headerText.includes('successtrans') && sortState.column === 'success') return true;
            if (headerText === 'pu' && sortState.column === 'pu') return true;
            return false;
        });

        if (sortedHeader) {
            const icon = sortState.direction === 'asc' ? ' \u25B2' : ' \u25BC'; // Up arrow or Down arrow
            sortedHeader.innerHTML += icon;
        }
    }
}

// Add click listeners to headers
headers.forEach(header => {
    // Determine the data key based on header text
    let dataKey;
    const text = header.innerText.toLowerCase();
    if (text.includes('gross booking')) {
        dataKey = 'gross';
    } else if (text.includes('success trans')) {
        dataKey = 'success';
    } else if (text.includes('pu')) {
        dataKey = 'pu';
    }

    if (dataKey) {
        // Style is handled in CSS, but we attach the event listener here
        header.addEventListener('click', () => sortData(dataKey));
    }
});


// --- Rendering Logic ---
function renderTable() {
  tbody.innerHTML = '';
  const totalGross = data.reduce((sum,d)=>sum+d.gross,0);
  const totalSuccess = data.reduce((sum,d)=>sum+d.success,0);
  const totalPU = data.reduce((sum,d)=>sum+d.pu,0);

  data.forEach(d=>{
    const tr = document.createElement('tr');

    function formatAdditional(value, total, prev) {
      let text = '';
      if(showPercent.checked) {
        text += ` (${((value/total)*100).toFixed(1)}%)`;
      }
      if(showDoD.checked) {
        const diff = ((value-prev)/prev*100).toFixed(1);
        // Handle division by zero for prev value gracefully
        const safeDiff = prev === 0 ? (value > 0 ? 1000 : 0) : ((value - prev) / prev * 100).toFixed(1);
        
        const cls = safeDiff >= 0 ? 'positive' : 'negative';
        
        // Use safeDiff for display
        text += ` <span class="${cls}">${safeDiff >= 0 ? '+' : ''}${safeDiff}%</span>`;
      }
      return text;
    }

    tr.innerHTML = `
      <td>${d.dimension}</td>
      <td>${d.gross.toLocaleString()}${formatAdditional(d.gross,totalGross,d.prevGross)}</td>
      <td>${d.success.toLocaleString()}${formatAdditional(d.success,totalSuccess,d.prevSuccess)}</td>
      <td>${d.pu.toLocaleString()}${formatAdditional(d.pu,totalPU,d.prevPU)}</td>
    `;

    tbody.appendChild(tr);
  });
}

// THAY ĐỔI: Chạy sortData('gross') với hướng mặc định 'desc'
sortData('gross'); 
updateHeaderIcons(); // Cập nhật icon sort

// Event listeners
showPercent.addEventListener('change', renderTable);
showDoD.addEventListener('change', renderTable);
</script>

</body>
</html>