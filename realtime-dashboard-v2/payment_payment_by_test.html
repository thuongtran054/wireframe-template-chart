<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Metrics Table with Toggles and Sorting</title>
<style>
  body {
    font-family: 'Be Vietnam Pro', sans-serif;
    padding: 10px;
    background: #fff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0px;
    font-size: 14px; /* Tăng tính gọn gàng cho nhiều cột */
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px 10px; /* Giảm padding */
    text-align: left;
    vertical-align: middle;
  }
  th {
    background-color: #f5f5f5;
    font-weight: 600;
    white-space: nowrap; /* Ngăn tiêu đề bị xuống dòng */
  }
  /* Style for clickable headers */
  th:not(:first-child) {
    cursor: pointer;
  }
  tr:nth-child(even){background-color: #fafafa;}
  .positive { color: #03c950; font-weight: 600; }
  .negative { color: #ed5a27; font-weight: 600; }
  .toggles {
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div class="toggles">
  <label><input type="checkbox" id="showPercent" checked> Show % of Total</label>
  &nbsp;&nbsp;
  <label><input type="checkbox" id="showDoD"> Show DoD</label>
</div>

<table>
  <thead>
    <tr>
      <th>Top Product</th>
      <th>Gross Booking</th>
      <th>Success Trans</th>
      <th>PU</th>
      <th>AOV</th>
      <th>ARPPU</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<script>
// Cập nhật dữ liệu với 3 metrics mới (AOV, ARPPU, Frequency)
const data = [
  { dimension: 'package.ws1.royal.web', gross: 120000, prevGross: 100000, success: 110, prevSuccess: 95, pu: 90, prevPU: 85, aov: 1090.9, prevAOV: 1052.6, arppu: 1333.3, prevARPPU: 1176.5, frequency: 1.2, prevFrequency: 1.1 },
  { dimension: 'package.ws2.silver.web', gross: 90000, prevGross: 95000, success: 85, prevSuccess: 90, pu: 80, prevPU: 85, aov: 1058.8, prevAOV: 1055.6, arppu: 1125.0, prevARPPU: 1117.6, frequency: 1.1, prevFrequency: 1.0 },
  { dimension: 'package.ws3.gold.web', gross: 150000, prevGross: 130000, success: 140, prevSuccess: 120, pu: 130, prevPU: 110, aov: 1071.4, prevAOV: 1083.3, arppu: 1153.8, prevARPPU: 1181.8, frequency: 1.0, prevFrequency: 1.0 },
  { dimension: 'package.ws4.platinum.web', gross: 70000, prevGross: 70000, success: 65, prevSuccess: 65, pu: 60, prevPU: 60, aov: 1076.9, prevAOV: 1076.9, arppu: 1166.7, prevARPPU: 1166.7, frequency: 1.3, prevFrequency: 1.2 },
  { dimension: 'package.ws5.basic.web', gross: 50000, prevGross: 45000, success: 45, prevSuccess: 42, pu: 40, prevPU: 38, aov: 1111.1, prevAOV: 1071.4, arppu: 1250.0, prevARPPU: 1184.2, frequency: 1.5, prevFrequency: 1.4 },
  { dimension: 'package.ws6.standard.web', gross: 60000, prevGross: 55000, success: 55, prevSuccess: 50, pu: 50, prevPU: 48, aov: 1090.9, prevAOV: 1100.0, arppu: 1200.0, prevARPPU: 1145.8, frequency: 1.1, prevFrequency: 1.1 },
  { dimension: 'package.ws7.premium.web', gross: 80000, prevGross: 75000, success: 75, prevSuccess: 70, pu: 70, prevPU: 65, aov: 1066.7, prevAOV: 1071.4, arppu: 1142.9, prevARPPU: 1153.8, frequency: 1.0, prevFrequency: 1.0 }
];

const tbody = document.getElementById('table-body');
const showPercent = document.getElementById('showPercent');
const showDoD = document.getElementById('showDoD');
// Cập nhật: Chọn tất cả các header trừ cột Dimension đầu tiên
const headers = document.querySelectorAll('th:not(:first-child)'); 

// THAY ĐỔI: Thiết lập trạng thái mặc định: sort theo 'gross' giảm dần ('desc')
let sortState = {
    column: 'gross',
    direction: 'desc' 
};

// --- Sorting Logic ---
function sortData(column) {
    // Determine new direction
    let direction = 'asc';
    if (sortState.column === column) {
        // Toggle direction if clicking the same column
        direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    }
    
    // Perform the sort
    data.sort((a, b) => {
        const valA = a[column];
        const valB = b[column];

        if (direction === 'asc') {
            return valA - valB;
        } else {
            return valB - valA;
        }
    });

    // Update sort state
    sortState.column = column;
    sortState.direction = direction;
    
    // Re-render
    renderTable();
    updateHeaderIcons();
}

function updateHeaderIcons() {
    // Clear all existing icons
    headers.forEach(header => {
        // Lưu trữ nội dung ban đầu (không có icon)
        let originalText = header.getAttribute('data-original-text');
        if (!originalText) {
            originalText = header.innerText.replace(/ \u25B2| \u25BC/g, '').trim();
            header.setAttribute('data-original-text', originalText);
        }
        header.innerHTML = originalText;
    });

    if (sortState.column) {
        // Mapping các key mới
        const keyMap = {
            'gross': 'Gross Booking',
            'success': 'Success Trans',
            'pu': 'PU',
            'aov': 'AOV',
            'arppu': 'ARPPU',
            'frequency': 'Frequency'
        };

        const targetHeaderText = keyMap[sortState.column];
        
        const sortedHeader = Array.from(headers).find(h => h.getAttribute('data-original-text') === targetHeaderText);

        if (sortedHeader) {
            const icon = sortState.direction === 'asc' ? ' \u25B2' : ' \u25BC'; // Up arrow or Down arrow
            sortedHeader.innerHTML += icon;
        }
    }
}

// Add click listeners to headers
headers.forEach(header => {
    // Lấy data key dựa trên nội dung header
    let dataKey;
    const text = header.innerText.toLowerCase();
    
    if (text.includes('gross booking')) {
        dataKey = 'gross';
    } else if (text.includes('success trans')) {
        dataKey = 'success';
    } else if (text.includes('pu')) {
        dataKey = 'pu';
    } else if (text.includes('aov')) {
        dataKey = 'aov';
    } else if (text.includes('arppu')) {
        dataKey = 'arppu';
    } else if (text.includes('frequency')) {
        dataKey = 'frequency';
    }

    // Lưu trữ text ban đầu để dễ dàng khôi phục khi cập nhật icon
    header.setAttribute('data-original-text', header.innerText);

    if (dataKey) {
        header.addEventListener('click', () => sortData(dataKey));
    }
});


// --- Rendering Logic ---
function renderTable() {
  tbody.innerHTML = '';
  // Tính tổng cho các cột cần tính % (chỉ Gross, Success, PU)
  const totalGross = data.reduce((sum,d)=>sum+d.gross,0);
  const totalSuccess = data.reduce((sum,d)=>sum+d.success,0);
  const totalPU = data.reduce((sum,d)=>sum+d.pu,0);


  data.forEach(d=>{
    const tr = document.createElement('tr');

    // Hàm format chung cho các chỉ số
    function formatAdditional(value, total, prev, isPercentTotalEnabled = true, decimalPlaces = 0) {
      let text = '';
      let formattedValue = value.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });

      if(isPercentTotalEnabled && showPercent.checked) {
        // Chỉ hiển thị % of Total cho Gross, Success, PU
        if (total > 0) {
            text += ` (${((value/total)*100).toFixed(1)}%)`;
        }
      }
      
      if(showDoD.checked) {
        const safeDiff = (prev === 0 || isNaN(prev)) ? (value > 0 ? 1000 : 0) : ((value - prev) / prev * 100);
        const safeDiffFixed = safeDiff.toFixed(1);
        
        const cls = safeDiff >= 0 ? 'positive' : 'negative';
        
        text += ` <span class="${cls}">${safeDiff >= 0 ? '+' : ''}${safeDiffFixed}%</span>`;
      }
      return formattedValue + text;
    }

    tr.innerHTML = `
      <td>${d.dimension}</td>
      <td>${formatAdditional(d.gross, totalGross, d.prevGross, true, 0)}</td>
      <td>${formatAdditional(d.success, totalSuccess, d.prevSuccess, true, 0)}</td>
      <td>${formatAdditional(d.pu, totalPU, d.prevPU, true, 0)}</td>
      <td>${formatAdditional(d.aov, 0, d.prevAOV, false, 1)}</td>
      <td>${formatAdditional(d.arppu, 0, d.prevARPPU, false, 1)}</td>
      <td>${formatAdditional(d.frequency, 0, d.prevFrequency, false, 1)}</td>
    `;

    tbody.appendChild(tr);
  });
}

// THAY ĐỔI: Chạy sortData('gross') với hướng mặc định 'desc'
sortData('gross'); 
updateHeaderIcons(); // Cập nhật icon sort

// Event listeners
showPercent.addEventListener('change', renderTable);
showDoD.addEventListener('change', renderTable);
</script>

</body>
</html>