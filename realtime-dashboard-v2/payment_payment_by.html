<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Metrics Table with Toggles and Sorting</title>
<style>
  body {
    font-family: 'Be Vietnam Pro', sans-serif;
    padding: 0px;
    background: #fff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0px;
    font-size: 12px; /* Tăng tính gọn gàng cho nhiều cột */
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px 10px; /* Giảm padding */
    text-align: left;
    vertical-align: middle;
  }
  th {
    background-color: #f5f5f5;
    font-weight: 400;
    white-space: nowrap; /* Ngăn tiêu đề bị xuống dòng */
  }
  /* Style for clickable headers */
  th:not(:first-child) {
    cursor: pointer;
  }
  tr:nth-child(even){background-color: #fafafa;}
  .positive { color: #03c950; font-weight: 400; }
  .negative { color: #EA3323; font-weight: 400; }
  .toggles {
    margin-bottom: 5px;
    font-size: 12px;
  }
</style>
</head>
<body>

<div class="toggles">
  <label><input type="checkbox" id="showPercent" checked> Show % of Total</label>
  &nbsp;&nbsp;
  <label><input type="checkbox" id="showDoD"> Show DoD (Full Day)</label>
  &nbsp;&nbsp;
  <label><input type="checkbox" id="showSameTimeDoD"> Show Same Time DoD</label> 
</div>

<table>
  <thead>
    <tr>
      <th>Top Product</th>
      <th>Gross Booking</th>
      <th>Success Trans</th>
      <th>PU</th>
      <th>AOV</th>
      <th>ARPPU</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<script>
// Cập nhật dữ liệu: Thêm các metrics cho 'Same Time Previous Day' (stp)
const data = [
  // Thêm stpGross, stpSuccess, stpPU, stpAOV, stpARPPU, stpFrequency
  { dimension: 'package.ws1.royal.web', gross: 120000, prevGross: 100000, stpGross: 95000, success: 110, prevSuccess: 95, stpSuccess: 88, pu: 90, prevPU: 85, stpPU: 82, aov: 1090.9, prevAOV: 1052.6, stpAOV: 1070.0, arppu: 1333.3, prevARPPU: 1176.5, stpARPPU: 1210.0, frequency: 1.2, prevFrequency: 1.1, stpFrequency: 1.15 },
  { dimension: 'package.ws2.silver.web', gross: 90000, prevGross: 95000, stpGross: 80000, success: 85, prevSuccess: 90, stpSuccess: 78, pu: 80, prevPU: 85, stpPU: 75, aov: 1058.8, prevAOV: 1055.6, stpAOV: 1025.6, arppu: 1125.0, prevARPPU: 1117.6, stpARPPU: 1066.7, frequency: 1.1, prevFrequency: 1.0, stpFrequency: 1.05 },
  { dimension: 'package.ws3.gold.web', gross: 150000, prevGross: 130000, stpGross: 140000, success: 140, prevSuccess: 120, stpSuccess: 135, pu: 130, prevPU: 110, stpPU: 125, aov: 1071.4, prevAOV: 1083.3, stpAOV: 1037.0, arppu: 1153.8, prevARPPU: 1181.8, stpARPPU: 1120.0, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws4.platinum.web', gross: 70000, prevGross: 70000, stpGross: 65000, success: 65, prevSuccess: 65, stpSuccess: 60, pu: 60, prevPU: 60, stpPU: 55, aov: 1076.9, prevAOV: 1076.9, stpAOV: 1083.3, arppu: 1166.7, prevARPPU: 1166.7, stpARPPU: 1181.8, frequency: 1.3, prevFrequency: 1.2, stpFrequency: 1.25 },
  { dimension: 'package.ws5.basic.web', gross: 50000, prevGross: 45000, stpGross: 48000, success: 45, prevSuccess: 42, stpSuccess: 43, pu: 40, prevPU: 38, stpPU: 39, aov: 1111.1, prevAOV: 1071.4, stpAOV: 1100.0, arppu: 1250.0, prevARPPU: 1184.2, stpARPPU: 1230.8, frequency: 1.5, prevFrequency: 1.4, stpFrequency: 1.45 },
  { dimension: 'package.ws6.standard.web', gross: 60000, prevGross: 55000, stpGross: 58000, success: 55, prevSuccess: 50, stpSuccess: 53, pu: 50, prevPU: 48, stpPU: 49, aov: 1090.9, prevAOV: 1100.0, stpAOV: 1094.3, arppu: 1200.0, prevARPPU: 1145.8, stpARPPU: 1183.7, frequency: 1.1, prevFrequency: 1.1, stpFrequency: 1.1 },
  { dimension: 'package.ws7.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws8.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws9.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws10.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws11.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
  { dimension: 'package.ws12.premium.web', gross: 80000, prevGross: 75000, stpGross: 78000, success: 75, prevSuccess: 70, stpSuccess: 73, pu: 70, prevPU: 65, stpPU: 68, aov: 1066.7, prevAOV: 1071.4, stpAOV: 1068.5, arppu: 1142.9, prevARPPU: 1153.8, stpARPPU: 1147.1, frequency: 1.0, prevFrequency: 1.0, stpFrequency: 1.0 },
];

const tbody = document.getElementById('table-body');
const showPercent = document.getElementById('showPercent');
const showDoD = document.getElementById('showDoD');
// NEW: Get the Same Time DoD checkbox
const showSameTimeDoD = document.getElementById('showSameTimeDoD'); 
const headers = document.querySelectorAll('th:not(:first-child)'); 

let sortState = {
    column: 'gross',
    direction: 'desc' // Đổi lại mặc định là 'desc' cho Gross Booking
};

// --- Sorting Logic (No change needed) ---
function sortData(column) {
    let direction = 'asc';
    if (sortState.column === column) {
        direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    }
    
    data.sort((a, b) => {
        const valA = a[column];
        const valB = b[column];

        if (direction === 'asc') {
            return valA - valB;
        } else {
            return valB - valA;
        }
    });

    sortState.column = column;
    sortState.direction = direction;
    
    renderTable();
    updateHeaderIcons();
}

function updateHeaderIcons() {
    headers.forEach(header => {
        let originalText = header.getAttribute('data-original-text');
        if (!originalText) {
            originalText = header.innerText.replace(/ \u25B2| \u25BC/g, '').trim();
            header.setAttribute('data-original-text', originalText);
        }
        header.innerHTML = originalText;
    });

    if (sortState.column) {
        const keyMap = {
            'gross': 'Gross Booking',
            'success': 'Success Trans',
            'pu': 'PU',
            'aov': 'AOV',
            'arppu': 'ARPPU',
            'frequency': 'Frequency'
        };

        const targetHeaderText = keyMap[sortState.column];
        
        const sortedHeader = Array.from(headers).find(h => h.getAttribute('data-original-text') === targetHeaderText);

        if (sortedHeader) {
            const icon = sortState.direction === 'asc' ? ' \u25B2' : ' \u25BC'; 
            sortedHeader.innerHTML += icon;
        }
    }
}

// Add click listeners to headers (No change needed)
headers.forEach(header => {
    let dataKey;
    const text = header.innerText.toLowerCase();
    
    if (text.includes('gross booking')) {
        dataKey = 'gross';
    } else if (text.includes('success trans')) {
        dataKey = 'success';
    } else if (text.includes('pu')) {
        dataKey = 'pu';
    } else if (text.includes('aov')) {
        dataKey = 'aov';
    } else if (text.includes('arppu')) {
        dataKey = 'arppu';
    } else if (text.includes('frequency')) {
        dataKey = 'frequency';
    }

    header.setAttribute('data-original-text', header.innerText);

    if (dataKey) {
        header.addEventListener('click', () => sortData(dataKey));
    }
});


// --- Rendering Logic (UPDATED) ---
function renderTable() {
  tbody.innerHTML = '';
  const totalGross = data.reduce((sum,d)=>sum+d.gross,0);
  const totalSuccess = data.reduce((sum,d)=>sum+d.success,0);
  const totalPU = data.reduce((sum,d)=>sum+d.pu,0);

    // UPDATED: Hàm format chung
    function formatAdditional(value, total, prevFullDay, prevSameTime, isPercentTotalEnabled = true, decimalPlaces = 0) {
      let text = '';
      let formattedValue = value.toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });

      // 1. Show % of Total
      if(isPercentTotalEnabled && showPercent.checked) {
        if (total > 0) {
            text += ` (${((value/total)*100).toFixed(1)}%)`;
        }
      }
      
      // 2. Show DoD (Full Day)
      if(showDoD.checked) {
        // Sử dụng prevFullDay
        const safeDiff = (prevFullDay === 0 || isNaN(prevFullDay)) ? (value > 0 ? 1000 : 0) : ((value - prevFullDay) / prevFullDay * 100);
        const safeDiffFixed = safeDiff.toFixed(1);
        
        const cls = safeDiff >= 0 ? 'positive' : 'negative';
        
        text += ` <span class="${cls}">[D] ${safeDiff >= 0 ? '+' : ''}${safeDiffFixed}%</span>`;
      }

      // 3. NEW: Show Same Time DoD
      if(showSameTimeDoD.checked) {
        // Sử dụng prevSameTime
        const safeDiffSTP = (prevSameTime === 0 || isNaN(prevSameTime)) ? (value > 0 ? 1000 : 0) : ((value - prevSameTime) / prevSameTime * 100);
        const safeDiffSTPFixed = safeDiffSTP.toFixed(1);
        
        const clsSTP = safeDiffSTP >= 0 ? 'positive' : 'negative';
        
        text += ` <span class="${clsSTP}">[ST] ${safeDiffSTP >= 0 ? '+' : ''}${safeDiffSTPFixed}%</span>`;
      }
      
      return formattedValue + text;
    }


  data.forEach(d=>{
    const tr = document.createElement('tr');
    
    tr.innerHTML = `
      <td>${d.dimension}</td>
      <td>${formatAdditional(d.gross, totalGross, d.prevGross, d.stpGross, true, 0)}</td>
      <td>${formatAdditional(d.success, totalSuccess, d.prevSuccess, d.stpSuccess, true, 0)}</td>
      <td>${formatAdditional(d.pu, totalPU, d.prevPU, d.stpPU, true, 0)}</td>
      <td>${formatAdditional(d.aov, 0, d.prevAOV, d.stpAOV, false, 1)}</td>
      <td>${formatAdditional(d.arppu, 0, d.prevARPPU, d.stpARPPU, false, 1)}</td>
      <td>${formatAdditional(d.frequency, 0, d.prevFrequency, d.stpFrequency, false, 1)}</td>
    `;

    tbody.appendChild(tr);
  });
}

// Chạy sortData('gross') với hướng mặc định 'desc'
sortData('gross'); 
updateHeaderIcons();

// Event listeners
showPercent.addEventListener('change', renderTable);
showDoD.addEventListener('change', renderTable);
// NEW: Add listener for Same Time DoD
showSameTimeDoD.addEventListener('change', renderTable); 
</script>

</body>
</html>